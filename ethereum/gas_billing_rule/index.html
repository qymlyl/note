<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-ethereum/gas_billing_rule" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">gas_billing_rule | qymlyl note</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://qymlyl.github.io/note/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://qymlyl.github.io/note/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://qymlyl.github.io/note/ethereum/gas_billing_rule"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="gas_billing_rule | qymlyl note"><meta data-rh="true" name="description" content="概述"><meta data-rh="true" property="og:description" content="概述"><link data-rh="true" rel="icon" href="/note/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://qymlyl.github.io/note/ethereum/gas_billing_rule"><link data-rh="true" rel="alternate" href="https://qymlyl.github.io/note/ethereum/gas_billing_rule" hreflang="en"><link data-rh="true" rel="alternate" href="https://qymlyl.github.io/note/zh-Hans/ethereum/gas_billing_rule" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://qymlyl.github.io/note/ethereum/gas_billing_rule" hreflang="x-default"><link rel="stylesheet" href="/note/assets/css/styles.75314c4a.css">
<link rel="preload" href="/note/assets/js/runtime~main.947b7046.js" as="script">
<link rel="preload" href="/note/assets/js/main.c4a289da.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/note/"><div class="navbar__logo"><img src="/note/img/logo.svg" alt="qymlyl note Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/note/img/logo.svg" alt="qymlyl note Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">qymlyl note</b></a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><main class="docMainContainer_gTbr docMainContainerEnhanced_Uz_u"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>gas_billing_rule</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="概述">概述<a href="#概述" class="hash-link" aria-label="Direct link to 概述" title="Direct link to 概述">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="call和transaction">Call和Transaction<a href="#call和transaction" class="hash-link" aria-label="Direct link to Call和Transaction" title="Direct link to Call和Transaction">​</a></h3><p>以太坊网络中在向网络中写入数据和读取数据之间进行了区分，即Call和Transaction。</p><p>1）<strong>Call：</strong></p><ul><li>调用是一种在以太坊网络上执行的本地操作，用于执行智能合约中的函数或者获取合约状态，但不会将状态更改写入区块链。</li><li>调用不包含发送者地址、以太币数量等信息，它只包含调用目标合约地址、调用数据（函数签名和参数）等信息。</li><li>调用不会产生 Gas 费用，因为它们只是本地执行，不需要在区块链上记录状态变化。</li><li>调用的结果会返回给调用者，但不会对区块链上的状态产生任何影响。</li></ul><p>2）<strong>Transaction：</strong></p><ul><li>交易是一种在以太坊网络上发送的信息单元，用于执行状态转换或触发智能合约中的函数调用。</li><li>交易必须包含发送者地址、接收者地址、以太币的数量（如果有的话）、Gas 限制、Gas 价格等信息。</li><li>交易是由以太坊网络中的矿工打包并写入区块链的，一旦被打包进区块，交易就会被执行，并且状态会被更新到区块链上。</li><li>交易可以修改合约状态、转移以太币、触发智能合约中的函数调用等。</li></ul><p>Transaction和Call在以太坊中用途不同，Transaction用于在区块链上执行状态转换和写入状态变化，而Call仅用于本地执行智能合约中的函数或获取合约状态，不会更改区块链上的状态。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="view函数和pure函数">view函数和pure函数<a href="#view函数和pure函数" class="hash-link" aria-label="Direct link to view函数和pure函数" title="Direct link to view函数和pure函数">​</a></h3><p>在智能合约内，可以使用 <code>view</code> 和 <code>pure</code> 关键字声明的函数是可以通过 Call 交易调用的类型。这两种函数类型有以下特点：</p><ol><li><strong>View 函数：</strong> 在智能合约内使用 <code>view</code> 关键字声明的函数表示这个函数只读取合约的状态，而不修改状态。View 函数执行的过程中不会修改区块链状态，因此可以通过 Call 交易来调用。在旧版本的 Solidity 中，<code>constant</code> 关键字也可以用来声明只读函数。</li><li><strong>Pure 函数：</strong> 在智能合约内使用 <code>pure</code> 关键字声明的函数表示这个函数不仅不会读取合约的状态，也不会修改状态，它只会基于给定的参数执行计算并返回结果。与 View 函数类似，Pure 函数也可以通过 Call 交易来调用。</li></ol><p>View函数和Pure函数对区别是，View函数中会对合约的状态数据进行读取，Pure函数中不涉及到合约内任何状态的操作即也不会对链上的合约状态数据进行读取。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="gas-price">Gas price<a href="#gas-price" class="hash-link" aria-label="Direct link to Gas price" title="Direct link to Gas price">​</a></h3><p>在EIP-1559提案实施之后，Gas 费用由两部分构成：基本费用（Base Fee）和优先费用（Priority Fee）。这两者共同决定了交易的总费用。</p><p>EIP-1559是以太坊的一个重大升级，旨在改善交易费用和市场的机制，引入了一个更可预测的交易费用系统，该系统将Gas价格分为两个主要组成部分：基础费用（Base Fee）和优先费用（Priority Fee）。</p><ol><li><strong>基本费用（Base Fee）：</strong> <ul><li>基本费用是由以太坊网络根据当前的网络拥堵情况动态确定的，它表示执行一单位 Gas 所需的成本。基础费用是每个区块中所有交易必须支付的最小费用，它是算法确定的，根据前一个区块的网络拥堵情况自动调整。</li><li>每个区块的基础费用可能上升或下降，这取决于区块是满的还是空的。如果区块超过了目标大小，基础费用会上升；如果区块小于目标大小，基础费用会下降。这种机制旨在使区块利用率自动调节到一个理想的平衡点。</li><li><strong>基础费用的支付是以Ether直接烧毁的形式进行的</strong>，这意味着这部分费用不会支付给矿工（或验证者），而是从总的以太币供应中永久移除。</li></ul></li><li><strong>优先费用（Priority Fee）：</strong> <ul><li>优先费用，也被称为小费或矿工小费，优先费用是由用户设置的，它表示用户愿意支付给矿工的 Gas 价格，用于提高交易的优先级，优先费用越高，矿工越有动力优先打包这笔交易。</li><li>优先费用是可选的，用户可以根据自己对交易速度的需求来设置这个费用的高低。优先费用完全支付给矿工（或验证者），作为处理交易的激励。</li></ul></li></ol><p>仅支付基本费用的交易在技术上是有效的，但不太可能被包含在内，因为它没有激励矿工选择它，优先费用取决于您发送交易时的网络使用情况，如果较为拥堵，那么可能需要将优先费用设置得更高，但当较为通畅时，可以支付更少的费用。</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">GasPrice </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 基本费用 + 优先费用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GasUsed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Gas消耗量 * GasPrice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">总费用 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Gas 消耗量 × </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">基本费用 + 优先费用</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>转账简单示例</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 以太坊中转账交易固定是21000单位的gas</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">例如，假设A向B支付1ETH。一笔ETH转账需要21000单位的gas，基本费用为10gwei。A设置2 gwei的小费。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">总费用现在等于：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">即21,000 * </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> + </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">252,000</span><span class="token plain"> gwei（0.000252 ETH）。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">当A汇款时，1.000252 ETH 将从A的账户中扣除。B将获得 </span><span class="token number" style="color:#36acaa">1.0000</span><span class="token plain"> ETH。矿工收到 </span><span class="token number" style="color:#36acaa">0.000042</span><span class="token plain"> ETH 的小费。0.00021 ETHbase fee被烧毁，这意味着它将被从流通中移除。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>更为复杂的合约交易，是由合约字节码执行情况确定的。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="gaslimit">GasLimit<a href="#gaslimit" class="hash-link" aria-label="Direct link to GasLimit" title="Direct link to GasLimit">​</a></h3><p>GasLimit时用户在发送交易时设置的Gas使用上限，表示用户愿意为执行该笔交易或智能合约操作支付的最大Gas数量。</p><p>如果交易消耗的Gas超过了用户设置的GasLimit，交易会执行失败，但是已经消耗的Gas并不会被退回。如果交易消耗的Gas低于GasLimit，则剩余的Gas会被退回。</p><p>GasLimit的存在主要作用是为了限制交易可能消耗的最大资源量，以避免因合约执行出错（如无限循环）而导致的过度费用。</p><p>GasLimit的上限理论上是没有限制的，用户可以设置一个非常高的数值。不过，这个设定的数值不能超过包含该交易的区块的Gas Limit，这是因为每个区块都有一个最大容量，即区块Gas Limit，它限制了该区块内所有交易Gas消耗总和的上限。</p><p>区块GasLimit是网络中每个区块能够处理的最大的Gas总量，这个限制确保了区块的处理时间和网络的问题，区块的Gas Limit是有矿工(或以太坊2.0中的验证者)通过一种投票的机制决定的，并可以随着时间进行调整，以响应网络负载的变化。</p><p>用户设置的Gas Limit反映了他们对交易执行复杂度的预估，如果一个交易的 Gas Limit 高到不切实际的程度，矿工可能会选择忽略这个交易，因为它可能看起来像是一个错误或是恶意的。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="与gas相关的eip">与Gas相关的EIP<a href="#与gas相关的eip" class="hash-link" aria-label="Direct link to 与Gas相关的EIP" title="Direct link to 与Gas相关的EIP">​</a></h2><p>在以太坊中，关于Gas（执行以太坊网络交易所需的计算资源费用）相关的EIP（Ethereum Improvement Proposals，以太坊改进提案）涉及对网络的费用模型、Gas价格、资源消耗限制等方面的优化和调整。这些提案旨在提高以太坊网络的效率、降低用户成本、增加网络的可扩展性和安全性。下面列出了一些重要的、与Gas相关的EIPs：</p><ol><li><strong>EIP-150</strong>: 旨在调整调用合约所需的Gas成本，以解决DoS攻击问题，通过增加某些操作的Gas成本来防止攻击者利用低成本的交易来拥堵网络。</li><li><strong>EIP-1559</strong>: 是一个非常重要的提案，它引入了一个基础费用（base fee）机制，该费用会根据网络拥堵情况自动调整，并将过量支付的费用销毁而不是支付给矿工，从而改善交易费用的市场和减少ETH的供应通胀。</li><li><strong>EIP-2200</strong>: 对SSTORE操作的Gas成本进行动态调整，考虑到存储槽的使用情况，优化智能合约的存储成本。</li><li><strong>EIP-2929</strong>: 为了提高网络的安全性，该提案增加了某些操作的Gas成本，特别是那些能够读取状态的操作，以防止可能的DoS攻击。</li><li><strong>EIP-2930</strong>: 引入了一种新的交易类型，允许预先声明一个交易将访问哪些地址和存储槽，以减少EIP-2929所增加的Gas成本。</li><li><strong>EIP-3198</strong>: 与EIP-1559配套，引入了一个名为<code>BASEFEE</code>的操作码，允许智能合约访问当前区块的基础费用。</li><li><strong>EIP-3529</strong>: 移除和减少Gas退款机制中的某些部分，以避免退款机制被滥用，从而影响网络的安全性和效率。</li><li><strong>EIP-3541</strong>: 禁止部署以<code>0xEF</code>字节开头的合约代码，为将来引入新的合约类型做准备。</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="eip-2929">EIP-2929<a href="#eip-2929" class="hash-link" aria-label="Direct link to EIP-2929" title="Direct link to EIP-2929">​</a></h3><p>在以太坊中，EIP-2929（Ethereum Improvement Proposal 2929）是一个提案，旨在增加特定操作码的气费成本，以更好地反映它们对网络资源的实际消耗。这个提案主要关注的是状态访问操作的气费，特别是 <code>SLOAD</code>、<code>CALL</code>、<code>CALLCODE</code>、<code>DELEGATECALL</code> 和 <code>STATICCALL</code> 操作。EIP-2929 引入了“冷”和“热”访问的概念，以区分对某个数据的首次访问（冷访问）和后续访问（热访问）。</p><p>在 EIP-2929 之前，访问智能合约的状态变量（例如通过 <code>SLOAD</code> 操作）的成本是固定的，不考虑该数据是否已经在之前被访问过。EIP-2929 引入了冷访问的概念，并为首次访问某个状态变量指定了更高的气费。指的是对已经被访问过的数据的再次访问。EIP-2929 规定，一旦某个数据在当前交易中被访问过（变“热”了），再次访问它的成本就会降低。</p><p><code>ColdSloadCostEIP2929(gas: 2100)</code> 是指按照 EIP-2929 规定，进行一次冷装载操作的气费成本。<code>WarmStorageReadCostEIP2929(gas: 100)</code> 是指进行一次热存储读取操作的气费成本。</p><p>这种区分反映了实际的资源消耗：从 EVM 的状态树中首次加载数据（冷访问）比访问已经在内存中的数据（热访问）更昂贵。</p><p>EIP-2929 的这种改变使得智能合约开发者需要更加注意他们合约的状态访问模式，以避免不必要的冷访问，从而优化合约的气费消耗。对于那些需要频繁读取同一状态变量的合约，合理地规划状态访问顺序可以显著降低交易成本。</p><p>同时，这也是以太坊对网络拥堵和高气费问题的一种应对措施，通过调整气费成本来鼓励更高效的智能合约编写和执行，以及更合理地利用网络资源。</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#概述" class="table-of-contents__link toc-highlight">概述</a><ul><li><a href="#call和transaction" class="table-of-contents__link toc-highlight">Call和Transaction</a></li><li><a href="#view函数和pure函数" class="table-of-contents__link toc-highlight">view函数和pure函数</a></li><li><a href="#gas-price" class="table-of-contents__link toc-highlight">Gas price</a></li><li><a href="#gaslimit" class="table-of-contents__link toc-highlight">GasLimit</a></li></ul></li><li><a href="#与gas相关的eip" class="table-of-contents__link toc-highlight">与Gas相关的EIP</a><ul><li><a href="#eip-2929" class="table-of-contents__link toc-highlight">EIP-2929</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 qymlyl note</div></div></div></footer></div>
<script src="/note/assets/js/runtime~main.947b7046.js"></script>
<script src="/note/assets/js/main.c4a289da.js"></script>
</body>
</html>